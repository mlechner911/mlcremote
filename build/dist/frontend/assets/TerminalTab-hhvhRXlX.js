import{u as A,R as x,j as n}from"./vendor-react-fUBbVULr.js";import{a as L,I as b,g as S,s as B,b as F}from"./index-CgPetO38.js";import{x as J,o as $}from"./vendor-xterm-DOcMqDAd.js";import"./vendor-scheduler-DYLXRpC5.js";import"./vendor-devlop-Cl3hj7Sz.js";import"./vendor-extend-BByqELpg.js";import"./vendor-unified-CN3Pc_0x.js";import"./vendor-bail-FqpXQuLt.js";import"./vendor-is-plain-obj-C1gvLhAf.js";import"./vendor-trough-B_b8ryxu.js";import"./vendor-vfile-BCWrK60u.js";import"./vendor-vfile-message-DqhD22jI.js";import"./vendor-unist-util-stringify-position-Ch_qCilz.js";import"./vendor-remark-parse-CNDkPE6C.js";import"./vendor-mdast-util-from-markdown-CHHsmDpx.js";import"./vendor-micromark-util-decode-numeric-character-reference-CNs1qBpV.js";import"./vendor-micromark-util-decode-string-fHsnqYdj.js";import"./vendor-decode-named-character-reference-C3-224fz.js";import"./vendor-micromark-util-normalize-identifier-C9ANKk3v.js";import"./vendor-micromark-Dc687xHH.js";import"./vendor-micromark-util-combine-extensions-d8XJZrgA.js";import"./vendor-micromark-util-chunked-DrRIdSP-.js";import"./vendor-micromark-factory-space-BM4zcA-B.js";import"./vendor-micromark-util-character-Cn8n62xE.js";import"./vendor-micromark-core-commonmark-BEN53qso.js";import"./vendor-micromark-util-classify-character-Bc1Mydac.js";import"./vendor-micromark-util-resolve-all-PQCKh0dx.js";import"./vendor-micromark-util-subtokenize-BF1Jf29a.js";import"./vendor-micromark-factory-destination-QK-4WEtY.js";import"./vendor-micromark-factory-label-Bo_B4AwM.js";import"./vendor-micromark-factory-title-D-E2MfTG.js";import"./vendor-micromark-factory-whitespace-D8F2YPRT.js";import"./vendor-micromark-util-html-tag-name-DbKNfynz.js";import"./vendor-mdast-util-to-string-C_aolqmU.js";import"./vendor-remark-rehype-Eq-g-hA4.js";import"./vendor-mdast-util-to-hast-B4KFU5Q1.js";import"./vendor-ungap--gfxRhYI.js";import"./vendor-micromark-util-sanitize-uri-B-zxHmez.js";import"./vendor-unist-util-position-60F3QETU.js";import"./vendor-trim-lines-D8znQY54.js";import"./vendor-unist-util-visit-DyPrGnGc.js";import"./vendor-unist-util-visit-parents-CHe-IBUw.js";import"./vendor-unist-util-is-D9KQvrmg.js";import"./vendor-hast-util-to-jsx-runtime-48tnp6nG.js";import"./vendor-comma-separated-tokens-xMQ5YY98.js";import"./vendor-property-information-Bx45xMUt.js";import"./vendor-space-separated-tokens-DD3iYX1K.js";import"./vendor-style-to-js-CGcDVYOI.js";import"./vendor-style-to-object-COD_8__P.js";import"./vendor-inline-style-parser-CWBJcU5N.js";import"./vendor-hast-util-whitespace-D4Wp6AEg.js";import"./vendor-estree-util-is-identifier-name-BgBfM8ME.js";import"./vendor-html-url-attributes-D46m5wfe.js";import"./vendor-prism-DmEJSkZI.js";import"./vendor-html2canvas-BfYXEYrK.js";import"./vendor-i18next-BnqEsHlA.js";import"./vendor-i18next-browser-languagedetector-ClvlpAgo.js";function Qt({shell:j,path:h,label:O,initialCommand:v,commandSignal:q,onExit:R}){const{t:m}=A(),y=x.useRef(null),p=x.useRef(null),P=x.useRef(null),u=x.useRef(null);x.useEffect(()=>{if(!y.current)return;const t=new J.Terminal({cols:80,rows:24}),a=new $;t.loadAddon(a),t.open(y.current),a.fit(),P.current=a,p.current=t;let c=null,r=null;const k=(o,s)=>{r=o,u.current=o,r.binaryType="arraybuffer",r.onopen=()=>{t.write(`\r
`+s+`\r
`);try{const e={type:"resize",cols:t.cols||80,rows:t.rows||24};r&&r.send(JSON.stringify(e))}catch{}v&&setTimeout(()=>{r&&r.readyState===WebSocket.OPEN&&r.send(v+`
`)},500)},r.onmessage=e=>{const f=typeof e.data=="string"?e.data:new TextDecoder().decode(e.data);t.write(f)},r.onclose=()=>{try{u.current&&(u.current=null)}catch{}if(R)try{R()}catch{}},t.onData(e=>{r&&r.readyState===WebSocket.OPEN&&r.send(e)})};(async o=>{try{const s=await B(o);return s&&s.isDir?o:s&&!s.isDir?o.replace(/\/[^/]*$/,"")||"/":o}catch{return o}})(h).then(o=>{const s=localStorage.getItem("mlcremote_token"),e=(l,d,w)=>{let i;try{i=new URL(l)}catch{i=new URL(l,location.origin)}i.protocol==="https:"?i.protocol="wss:":i.protocol==="http:"&&(i.protocol="ws:");const C=i.pathname.endsWith("/")?i.pathname.slice(0,-1):i.pathname,D=d.startsWith("/")?d:"/"+d;return i.pathname=C+D,Object.entries(w).forEach(([W,U])=>{i.searchParams.set(W,U)}),i.toString()},f=F()||location.origin,T="/ws/terminal",g={shell:j,cwd:o};s&&(g.token=s);const I=new URLSearchParams(g);L(`/api/terminal/new?${I.toString()}`).then(l=>l.json()).then(l=>{c=l.id;const d={...g,session:c||""},w=e(f,T,d),i=new WebSocket(w);k(i,m("terminal_connected_session",{id:c}))}).catch(()=>{const l={...g},d=e(f,T,l),w=new WebSocket(d);k(w,m("terminal_connected_ephemeral"))})});const z=()=>{var o;try{(o=P.current)==null||o.fit();const s=p.current,e=u.current;if(!s||!e||e.readyState!==WebSocket.OPEN)return;const f={type:"resize",cols:s.cols||80,rows:s.rows||24};e.send(JSON.stringify(f))}catch{}},N=new ResizeObserver(()=>{requestAnimationFrame(()=>z())});return y.current&&N.observe(y.current),()=>{N.disconnect();try{r&&r.close()}catch{}u.current=null;try{t.dispose()}catch{}}},[j,h,m]);const E=O||m("terminal"),_=h.startsWith("task-")||h.startsWith("shell-")?"":h;return n.jsxs("div",{className:"terminal-root",style:{display:"flex",flexDirection:"column",height:"100%"},children:[n.jsxs("div",{className:"editor-header",children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[n.jsx(b,{name:S("terminal"),size:14}),n.jsx("strong",{children:E})]}),_&&n.jsx("div",{style:{display:"flex",flexDirection:"column"},children:n.jsx("div",{style:{display:"flex",alignItems:"center",gap:8},children:n.jsx("span",{className:"muted",children:_})})}),n.jsxs("div",{className:"actions",style:{display:"flex",gap:4},children:[n.jsx("button",{className:"icon-btn",title:m("copy"),onClick:async()=>{var t;try{const a=p.current&&p.current.getSelection&&p.current.getSelection()||((t=window.getSelection())==null?void 0:t.toString())||"";if(!a)return;if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(a);else{const c=document.createElement("textarea");c.value=a,document.body.appendChild(c),c.select(),document.execCommand("copy"),document.body.removeChild(c)}}catch(a){console.warn("copy failed",a)}},children:n.jsx(b,{name:S("copy"),size:14})}),n.jsx("button",{className:"icon-btn",title:m("paste"),onClick:async()=>{try{let t="";if(navigator.clipboard&&navigator.clipboard.readText?t=await navigator.clipboard.readText():t=window.prompt(m("paste_text_here"))||"",!t)return;const a=u.current;a&&a.readyState===WebSocket.OPEN?a.send(t):p.current&&p.current.write(t)}catch(t){console.warn("paste failed",t)}},children:n.jsx(b,{name:S("paste"),size:14})})]})]}),n.jsx("div",{className:"terminal-body",ref:y})]})}export{Qt as default};
