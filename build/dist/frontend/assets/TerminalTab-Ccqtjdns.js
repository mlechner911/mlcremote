import{u as E,R as y,j as m}from"./vendor-react-DgaSUS5F.js";import{a as C,s as U,g as z}from"./index-BSVllU0I.js";import{x as D,o as A}from"./vendor-xterm-DOcMqDAd.js";import"./vendor-scheduler-DYLXRpC5.js";import"./vendor-prism-D73ALYcd.js";import"./vendor-html2canvas-BfYXEYrK.js";import"./vendor-i18next-BnqEsHlA.js";import"./vendor-i18next-browser-languagedetector-ClvlpAgo.js";function K({shell:x,path:g,onExit:S}){const{t:u}=E(),w=y.useRef(null),l=y.useRef(null),v=y.useRef(null),f=y.useRef(null);return y.useEffect(()=>{if(!w.current)return;const e=new D.Terminal({cols:80,rows:24}),o=new A;e.loadAddon(o),e.open(w.current),o.fit(),v.current=o,l.current=e;let a=null,c=null;const R=(n,t)=>{c=n,f.current=n,c.binaryType="arraybuffer",c.onopen=()=>{e.write(`\r
`+t+`\r
`);try{const r={type:"resize",cols:e.cols||80,rows:e.rows||24};c&&c.send(JSON.stringify(r))}catch{}},c.onmessage=r=>{const p=typeof r.data=="string"?r.data:new TextDecoder().decode(r.data);e.write(p)},c.onclose=()=>{try{f.current&&(f.current=null)}catch{}if(S)try{S()}catch{}},e.onData(r=>{c&&c.readyState===WebSocket.OPEN&&c.send(r)})};(async n=>{try{const t=await U(n);return t&&t.exists&&t.isDir?n:t&&t.exists&&!t.isDir?n.replace(/\/[^/]*$/,"")||"/":n}catch{return n}})(g).then(n=>{const t=localStorage.getItem("mlcremote_token"),r=(i,d,h)=>{let s;try{s=new URL(i)}catch{s=new URL(i,location.origin)}s.protocol==="https:"?s.protocol="wss:":s.protocol==="http:"&&(s.protocol="ws:");const T=s.pathname.endsWith("/")?s.pathname.slice(0,-1):s.pathname,O=d.startsWith("/")?d:"/"+d;return s.pathname=T+O,Object.entries(h).forEach(([P,W])=>{s.searchParams.set(P,W)}),s.toString()},p=z()||location.origin,j="/ws/terminal",b={shell:x,cwd:n};t&&(b.token=t);const N=new URLSearchParams(b);C(`/api/terminal/new?${N.toString()}`).then(i=>i.json()).then(i=>{a=i.id;const d={...b,session:a},h=r(p,j,d),s=new WebSocket(h);R(s,u("terminal_connected_session",{id:a}))}).catch(()=>{const i={...b},d=r(p,j,i),h=new WebSocket(d);R(h,u("terminal_connected_ephemeral"))})});const k=()=>{var n;try{(n=v.current)==null||n.fit();const t=l.current,r=f.current;if(!t||!r||r.readyState!==WebSocket.OPEN)return;const p={type:"resize",cols:t.cols||80,rows:t.rows||24};r.send(JSON.stringify(p))}catch{}},_=new ResizeObserver(()=>{requestAnimationFrame(()=>k())});return w.current&&_.observe(w.current),()=>{_.disconnect();try{c&&c.close()}catch{}f.current=null;try{e.dispose()}catch{}}},[x,g,u]),m.jsxs("div",{className:"terminal-root",children:[m.jsxs("div",{className:"terminal-header",children:[m.jsx("strong",{children:g}),m.jsxs("div",{className:"terminal-controls",children:[m.jsx("button",{className:"btn",onClick:async()=>{var e;try{const o=l.current&&l.current.getSelection&&l.current.getSelection()||((e=window.getSelection())==null?void 0:e.toString())||"";if(!o)return;if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(o);else{const a=document.createElement("textarea");a.value=o,document.body.appendChild(a),a.select(),document.execCommand("copy"),document.body.removeChild(a)}}catch(o){console.warn("copy failed",o)}},children:u("copy")}),m.jsx("button",{className:"btn",onClick:async()=>{try{let e="";if(navigator.clipboard&&navigator.clipboard.readText?e=await navigator.clipboard.readText():e=window.prompt(u("paste_text_here"))||"",!e)return;const o=f.current;o&&o.readyState===WebSocket.OPEN?o.send(e):l.current&&l.current.write(e)}catch(e){console.warn("paste failed",e)}},children:u("paste")})]})]}),m.jsx("div",{className:"terminal-body",ref:w})]})}export{K as default};
