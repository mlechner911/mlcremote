<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connection Debugger</title>
    <style>
        body { font-family: monospace; background: #1e1e1e; color: #d4d4d4; padding: 20px; }
        .log { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .error { color: #f48771; }
        .success { color: #89d185; }
        .info { color: #569cd6; }
    </style>
</head>
<body>
    <h2>üîç Connection Debugger</h2>
    <div id="output"></div>

    <script>
        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            document.getElementById('output').appendChild(div);
            console.log(msg);
        }

        async function run() {
            try {
                log('Starting initialization...', 'info');
                
                // 1. Parse URL Params
                const params = new URLSearchParams(window.location.search);
                const apiParam = params.get('api');
                const langParam = params.get('lang') || 'not set'; // Check for lang too
                
                log(`Raw URL: ${window.location.href}`);
                log(`API Parameter: ${apiParam ? apiParam : 'MISSING'}`, apiParam ? 'info' : 'error');
                log(`Lang Parameter: ${langParam}`);

                if (!apiParam) {
                    log('CRITICAL: No "api" parameter found in URL.', 'error');
                    return;
                }

                // 2. Construct Base URL
                let apiObj;
                try {
                    apiObj = new URL(apiParam);
                } catch (e) {
                    log(`Failed to parse API param as URL: ${e.message}`, 'error');
                    return;
                }

                log(`Parsed Origin: ${apiObj.origin}`);
                log(`Parsed Pathname: ${apiObj.pathname}`);
                log(`Parsed Search: ${apiObj.search}`);

                // Replicate api.ts fix logic
                let base = apiObj.origin + apiObj.pathname;
                if (base.endsWith('/')) {
                    log('Trimming trailing slash from base URL.', 'info');
                    base = base.slice(0, -1);
                }
                
                log(`Final Base URL: ${base}`, 'success');

                // 3. Test Connection
                const healthUrl = `${base}/health`;
                log(`Attempting fetch to: ${healthUrl}`, 'info');

                const start = Date.now();
                const res = await fetch(healthUrl);
                const duration = Date.now() - start;
                
                log(`Fetch completed in ${duration}ms. Status: ${res.status} ${res.statusText}`, res.ok ? 'success' : 'error');
                log(`Content-Type: ${res.headers.get('content-type')}`);

                const text = await res.text();
                log(`Response Body Preview (first 100 chars):`, 'info');
                log(text.substring(0, 100));

                if (text.trim().startsWith('<')) {
                     log('CRITICAL: Response starts with "<", indicating HTML. This causes the JSON error!', 'error');
                     log('This means the backend is returning a default page instead of the API response.', 'error');
                } else {
                    try {
                        const json = JSON.parse(text);
                        log('JSON Parse: SUCCESS', 'success');
                        log(`Server Version: ${json.version || 'unknown'}`);
                        log(`Server OS/Arch: ${json.os}/${json.arch}`);
                    } catch (e) {
                        log(`JSON Parse: FAILED - ${e.message}`, 'error');
                    }
                }

            } catch (e) {
                log(`Unexpected Error: ${e.message}`, 'error');
                console.error(e);
            }
        }

        run();
    </script>
</body>
</html>
