import{u as U,R as y,j as l}from"./vendor-react-DgaSUS5F.js";import{a as _,s as v,g as S}from"./index-CnT1TvHp.js";import{x as j,o as N}from"./vendor-xterm-DOcMqDAd.js";import"./vendor-scheduler-DYLXRpC5.js";import"./vendor-prism-D73ALYcd.js";import"./vendor-html2canvas-BfYXEYrK.js";import"./vendor-i18next-BnqEsHlA.js";import"./vendor-i18next-browser-languagedetector-ClvlpAgo.js";function B({shell:u,path:p,onExit:b}){const{t:d}=U(),f=y.useRef(null),i=y.useRef(null),x=y.useRef(null),m=y.useRef(null);return y.useEffect(()=>{if(!f.current)return;const e=new j.Terminal({cols:80,rows:24}),r=new N;e.loadAddon(r),e.open(f.current),r.fit(),x.current=r,i.current=e;let a=null,c=null;const C=(n,t)=>{c=n,m.current=n,c.binaryType="arraybuffer",c.onopen=()=>{e.write(`\r
`+t+`\r
`);try{const o={type:"resize",cols:e.cols||80,rows:e.rows||24};c&&c.send(JSON.stringify(o))}catch{}},c.onmessage=o=>{const s=typeof o.data=="string"?o.data:new TextDecoder().decode(o.data);e.write(s)},c.onclose=()=>{try{m.current&&(m.current=null)}catch{}if(b)try{b()}catch{}},e.onData(o=>{c&&c.readyState===WebSocket.OPEN&&c.send(o)})};(async n=>{try{const t=await v(n);return t&&t.exists&&t.isDir?n:t&&t.exists&&!t.isDir?n.replace(/\/[^/]*$/,"")||"/":n}catch{return n}})(p).then(n=>{const t=localStorage.getItem("mlcremote_token"),o=t?`?shell=${encodeURIComponent(u)}&cwd=${encodeURIComponent(n)}&token=${encodeURIComponent(t)}`:`?shell=${encodeURIComponent(u)}&cwd=${encodeURIComponent(n)}`;_(`/api/terminal/new${o}`).then(s=>s.json()).then(s=>{a=s.id;const h=localStorage.getItem("mlcremote_token"),g=h?`?session=${encodeURIComponent(a)}&token=${encodeURIComponent(h)}`:`?session=${encodeURIComponent(a)}`;let w=location.origin.replace(/^http/,"ws");const R=S();R&&(w=R.replace(/^http/,"ws"));const I=new WebSocket(`${w}/ws/terminal${g}`);C(I,d("terminal_connected_session",{id:a}))}).catch(()=>{const s=localStorage.getItem("mlcremote_token"),h=s?`?shell=${encodeURIComponent(u)}&cwd=${encodeURIComponent(p)}&token=${encodeURIComponent(s)}`:`?shell=${encodeURIComponent(u)}&cwd=${encodeURIComponent(p)}`;let g=location.origin.replace(/^http/,"ws");const w=S();w&&(g=w.replace(/^http/,"ws"));const R=new WebSocket(`${g}/ws/terminal${h}`);C(R,d("terminal_connected_ephemeral"))})});const k=()=>{var n;try{(n=x.current)==null||n.fit();const t=i.current,o=m.current;if(!t||!o||o.readyState!==WebSocket.OPEN)return;const s={type:"resize",cols:t.cols||80,rows:t.rows||24};o.send(JSON.stringify(s))}catch{}},$=new ResizeObserver(()=>{requestAnimationFrame(()=>k())});return f.current&&$.observe(f.current),()=>{$.disconnect();try{c&&c.close()}catch{}m.current=null;try{e.dispose()}catch{}}},[u,p,d]),l.jsxs("div",{className:"terminal-root",children:[l.jsxs("div",{className:"terminal-header",children:[l.jsx("strong",{children:p}),l.jsxs("div",{className:"terminal-controls",children:[l.jsx("button",{className:"btn",onClick:async()=>{var e;try{const r=i.current&&i.current.getSelection&&i.current.getSelection()||((e=window.getSelection())==null?void 0:e.toString())||"";if(!r)return;if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(r);else{const a=document.createElement("textarea");a.value=r,document.body.appendChild(a),a.select(),document.execCommand("copy"),document.body.removeChild(a)}}catch(r){console.warn("copy failed",r)}},children:d("copy")}),l.jsx("button",{className:"btn",onClick:async()=>{try{let e="";if(navigator.clipboard&&navigator.clipboard.readText?e=await navigator.clipboard.readText():e=window.prompt(d("paste_text_here"))||"",!e)return;const r=m.current;r&&r.readyState===WebSocket.OPEN?r.send(e):i.current&&i.current.write(e)}catch(e){console.warn("paste failed",e)}},children:d("paste")})]})]}),l.jsx("div",{className:"terminal-body",ref:f})]})}export{B as default};
