import{R as f,j as i}from"./vendor-react-BXEsipma.js";import{a as I,s as U,g as $}from"./index-Fimewn2f.js";import{x as v,o as j}from"./vendor-xterm-BXin3HzJ.js";import"./vendor-scheduler-CWG1rEj-.js";import"./vendor-prism-DbuqXO-2.js";import"./vendor-html2canvas-k0ITeQhV.js";function z({shell:d,path:m,onExit:R}){const u=f.useRef(null),a=f.useRef(null),b=f.useRef(null),l=f.useRef(null);return f.useEffect(()=>{if(!u.current)return;const e=new v.Terminal({cols:80,rows:24}),r=new j;e.loadAddon(r),e.open(u.current),r.fit(),b.current=r,a.current=e;let w=null,c=null;const x=(t,n)=>{c=t,l.current=t,c.binaryType="arraybuffer",c.onopen=()=>{e.write(`\r
`+n+`\r
`);try{const o={type:"resize",cols:e.cols||80,rows:e.rows||24};c&&c.send(JSON.stringify(o))}catch{}},c.onmessage=o=>{const s=typeof o.data=="string"?o.data:new TextDecoder().decode(o.data);e.write(s)},c.onclose=()=>{try{l.current&&(l.current=null)}catch{}if(R)try{R()}catch{}},e.onData(o=>{c&&c.readyState===WebSocket.OPEN&&c.send(o)})};(async t=>{try{const n=await U(t);return n&&n.exists&&n.isDir?t:n&&n.exists&&!n.isDir?t.replace(/\/[^/]*$/,"")||"/":t}catch{return t}})(m).then(t=>{const n=localStorage.getItem("mlcremote_token"),o=n?`?shell=${encodeURIComponent(d)}&cwd=${encodeURIComponent(t)}&token=${encodeURIComponent(n)}`:`?shell=${encodeURIComponent(d)}&cwd=${encodeURIComponent(t)}`;I(`/api/terminal/new${o}`).then(s=>s.json()).then(s=>{w=s.id;const h=localStorage.getItem("mlcremote_token"),y=h?`?session=${encodeURIComponent(w)}&token=${encodeURIComponent(h)}`:`?session=${encodeURIComponent(w)}`;let p=location.origin.replace(/^http/,"ws");const g=$();g&&(p=g.replace(/^http/,"ws"));const k=new WebSocket(`${p}/ws/terminal${y}`);x(k,"Connected to shell session: "+w)}).catch(()=>{const s=localStorage.getItem("mlcremote_token"),h=s?`?shell=${encodeURIComponent(d)}&cwd=${encodeURIComponent(m)}&token=${encodeURIComponent(s)}`:`?shell=${encodeURIComponent(d)}&cwd=${encodeURIComponent(m)}`;let y=location.origin.replace(/^http/,"ws");const p=$();p&&(y=p.replace(/^http/,"ws"));const g=new WebSocket(`${y}/ws/terminal${h}`);x(g,"Connected to ephemeral shell")})});const S=()=>{try{b.current?.fit();const t=a.current,n=l.current;if(!t||!n||n.readyState!==WebSocket.OPEN)return;const o={type:"resize",cols:t.cols||80,rows:t.rows||24};n.send(JSON.stringify(o))}catch{}},C=new ResizeObserver(()=>{requestAnimationFrame(()=>S())});return u.current&&C.observe(u.current),()=>{C.disconnect();try{c&&c.close()}catch{}l.current=null;try{e.dispose()}catch{}}},[d,m]),i.jsxs("div",{className:"terminal-root",children:[i.jsxs("div",{className:"terminal-header",children:[i.jsx("strong",{children:m}),i.jsxs("div",{className:"terminal-controls",children:[i.jsx("button",{className:"btn",onClick:async()=>{try{const e=a.current&&a.current.getSelection&&a.current.getSelection()||window.getSelection()?.toString()||"";if(!e)return;if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(e);else{const r=document.createElement("textarea");r.value=e,document.body.appendChild(r),r.select(),document.execCommand("copy"),document.body.removeChild(r)}}catch(e){console.warn("copy failed",e)}},children:"Copy"}),i.jsx("button",{className:"btn",onClick:async()=>{try{let e="";if(navigator.clipboard&&navigator.clipboard.readText?e=await navigator.clipboard.readText():e=window.prompt("Paste text here")||"",!e)return;const r=l.current;r&&r.readyState===WebSocket.OPEN?r.send(e):a.current&&a.current.write(e)}catch(e){console.warn("paste failed",e)}},children:"Paste"})]})]}),i.jsx("div",{className:"terminal-body",ref:u})]})}export{z as default};
