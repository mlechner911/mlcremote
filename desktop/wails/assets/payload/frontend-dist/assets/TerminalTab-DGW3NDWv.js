import{R as u,j as i}from"./vendor-react-DS53xkUv.js";import{a as b,s as $}from"./index-DqoqcUb_.js";import{x as S,o as k}from"./vendor-xterm-BXin3HzJ.js";import"./vendor-scheduler-CWG1rEj-.js";import"./vendor-prism-DR-dfdyj.js";import"./vendor-html2canvas-k0ITeQhV.js";function z({shell:d,path:m,onExit:h}){const f=u.useRef(null),a=u.useRef(null),R=u.useRef(null),l=u.useRef(null);return u.useEffect(()=>{if(!f.current)return;const e=new S.Terminal({cols:80,rows:24}),r=new k;e.loadAddon(r),e.open(f.current),r.fit(),R.current=r,a.current=e;let p=null,c=null;const g=(t,n)=>{c=t,l.current=t,c.binaryType="arraybuffer",c.onopen=()=>{e.write(`\r
`+n+`\r
`);try{const o={type:"resize",cols:e.cols||80,rows:e.rows||24};c&&c.send(JSON.stringify(o))}catch{}},c.onmessage=o=>{const s=typeof o.data=="string"?o.data:new TextDecoder().decode(o.data);e.write(s)},c.onclose=()=>{try{l.current&&(l.current=null)}catch{}if(h)try{h()}catch{}},e.onData(o=>{c&&c.readyState===WebSocket.OPEN&&c.send(o)})};(async t=>{try{const n=await $(t);return n&&n.exists&&n.isDir?t:n&&n.exists&&!n.isDir?t.replace(/\/[^/]*$/,"")||"/":t}catch{return t}})(m).then(t=>{const n=localStorage.getItem("mlcremote_token"),o=n?`?shell=${encodeURIComponent(d)}&cwd=${encodeURIComponent(t)}&token=${encodeURIComponent(n)}`:`?shell=${encodeURIComponent(d)}&cwd=${encodeURIComponent(t)}`;b(`/api/terminal/new${o}`).then(s=>s.json()).then(s=>{p=s.id;const w=localStorage.getItem("mlcremote_token"),y=w?`?session=${encodeURIComponent(p)}&token=${encodeURIComponent(w)}`:`?session=${encodeURIComponent(p)}`,C=new WebSocket(`${location.origin.replace(/^http/,"ws")}/ws/terminal${y}`);g(C,"Connected to shell session: "+p)}).catch(()=>{const s=localStorage.getItem("mlcremote_token"),w=s?`?shell=${encodeURIComponent(d)}&cwd=${encodeURIComponent(m)}&token=${encodeURIComponent(s)}`:`?shell=${encodeURIComponent(d)}&cwd=${encodeURIComponent(m)}`,y=new WebSocket(`${location.origin.replace(/^http/,"ws")}/ws/terminal${w}`);g(y,"Connected to ephemeral shell")})});const x=()=>{try{R.current?.fit();const t=a.current,n=l.current;if(!t||!n||n.readyState!==WebSocket.OPEN)return;const o={type:"resize",cols:t.cols||80,rows:t.rows||24};n.send(JSON.stringify(o))}catch{}};return window.addEventListener("resize",x),()=>{window.removeEventListener("resize",x);try{c&&c.close()}catch{}l.current=null;try{e.dispose()}catch{}}},[d,m]),i.jsxs("div",{className:"terminal-root",children:[i.jsxs("div",{className:"terminal-header",children:[i.jsx("strong",{children:m}),i.jsxs("div",{className:"terminal-controls",children:[i.jsx("button",{className:"btn",onClick:async()=>{try{const e=a.current&&a.current.getSelection&&a.current.getSelection()||window.getSelection()?.toString()||"";if(!e)return;if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(e);else{const r=document.createElement("textarea");r.value=e,document.body.appendChild(r),r.select(),document.execCommand("copy"),document.body.removeChild(r)}}catch(e){console.warn("copy failed",e)}},children:"Copy"}),i.jsx("button",{className:"btn",onClick:async()=>{try{let e="";if(navigator.clipboard&&navigator.clipboard.readText?e=await navigator.clipboard.readText():e=window.prompt("Paste text here")||"",!e)return;const r=l.current;r&&r.readyState===WebSocket.OPEN?r.send(e):a.current&&a.current.write(e)}catch(e){console.warn("paste failed",e)}},children:"Paste"})]})]}),i.jsx("div",{className:"terminal-body",ref:f})]})}export{z as default};
